name: 'Chromatic - Testes Visuais'

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.storybook/**'
      - 'package.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.storybook/**'
      - 'package.json'
  # Permite execu√ß√£o manual a partir da aba Actions no GitHub
  workflow_dispatch:

jobs:
  chromatic-deployment:
    name: 'Publicar Storybook no Chromatic'
    runs-on: ubuntu-latest
    
    steps:
      # Checkout do c√≥digo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Chromatic precisa do hist√≥rico completo
      
      # Setup do Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      # Instalar depend√™ncias
      - name: Instalar depend√™ncias
        run: npm ci
      
      # Publicar no Chromatic
      - name: Publicar no Chromatic
        uses: chromaui/action@v1
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          exitZeroOnChanges: true  # N√£o falha o CI se houver altera√ß√µes visuais
          exitOnceUploaded: true   # Termina ap√≥s o upload, para agilizar o CI
          onlyChanged: true        # Testa apenas hist√≥rias que tenham mudado
          skip: ${{ github.event_name == 'pull_request' && github.actor == 'dependabot[bot]' }}
          
      # Adiciona um coment√°rio em PRs com o link para o Storybook publicado
      - name: Adicionar coment√°rio em PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo } } = context;
            const buildUrl = `https://682112af9250108fa51bec2a-gspkzoejsm.chromatic.com`;
            
            github.rest.issues.createComment({
              issue_number,
              owner,
              repo,
              body: `üìö **Storybook publicado!**\n\nVoc√™ pode verificar as mudan√ßas visuais em:\n[Chromatic Build](${buildUrl})`
            }); 