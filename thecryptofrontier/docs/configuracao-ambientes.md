# üåç Configura√ß√£o de Ambientes - The Crypto Frontier

Documenta√ß√£o completa sobre a estrutura de ambientes do projeto multil√≠ngue.

## üèóÔ∏è **Vis√£o Geral da Arquitetura**

O projeto utiliza uma estrutura bem organizada de **ambientes isolados** para garantir seguran√ßa entre desenvolvimento local, preview e produ√ß√£o.

```
üåç AMBIENTES DO PROJETO

üì¶ FRONTEND (Next.js)
‚îú‚îÄ‚îÄ üü† .env.local        ‚Üí Desenvolvimento local (localhost:3300)
‚îú‚îÄ‚îÄ üü° .env.preview      ‚Üí Ambiente de preview/staging
‚îú‚îÄ‚îÄ üü¢ .env.production   ‚Üí Ambiente de produ√ß√£o
‚îî‚îÄ‚îÄ üåê Site: thecryptofrontier.agentesintegrados.com

üìä BACKEND STRAPI
‚îú‚îÄ‚îÄ üü° Preview/Dev       ‚Üí ale-blog-preview.agentesintegrados.com:1340
‚îú‚îÄ‚îÄ üü¢ Produ√ß√£o          ‚Üí ale-blog.agentesintegrados.com:1339
‚îî‚îÄ‚îÄ üóÑÔ∏è PostgreSQL        ‚Üí Bancos isolados por ambiente
```

---

## üìÅ **Estrutura de Arquivos de Ambiente**

### **`.env.local` (Desenvolvimento Local)**
Arquivo usado quando voc√™ roda `npm run dev` (localhost:3300):

```bash
# Telemetria e Analytics
NEXT_TELEMETRY_DISABLED=1
NEXT_PUBLIC_GA_MEASUREMENT_ID=G-SFGD9XKTLD

# Redis (para Docker)
REDIS_HOST=redis
REDIS_PORT=6379

# Strapi Preview/Development (CONECTA COM PREVIEW!)
NEXT_PUBLIC_STRAPI_URL=https://ale-blog-preview.agentesintegrados.com
STRAPI_API_TOKEN=[preview_token_longo]
NEXT_PUBLIC_STRAPI_API_TOKEN=[preview_token_longo]

# Algolia Development
NEXT_PUBLIC_ALGOLIA_APP_ID=42TZWHW8UP
NEXT_PUBLIC_ALGOLIA_SEARCH_API_KEY=b32edbeb383fc3d1279658e7c3661843
NEXT_PUBLIC_ALGOLIA_INDEX_NAME=development_mcpx_content
ALGOLIA_ADMIN_API_KEY=d0cb55ec8f07832bc5f57da0bd25c535
ALGOLIA_WRITE_API_KEY=197d9ad99abb5bb69b4703dfb4820d2c

# Google API
GOOGLE_API_KEY=AIzaSyALJKZfAQLrHp-pRJmUZDJvESIWYQ8561U
```

### **`.env.preview` (Desenvolvimento/Preview)**
Todas as configura√ß√µes para o ambiente de testes:

```bash
# Telemetria e Analytics
NEXT_TELEMETRY_DISABLED=1
NEXT_PUBLIC_GA_MEASUREMENT_ID=G-SFGD9XKTLD

# Redis (para Docker)
REDIS_HOST=redis
REDIS_PORT=6379

# Strapi Preview/Development
NEXT_PUBLIC_STRAPI_URL=https://ale-blog-preview.agentesintegrados.com
STRAPI_API_TOKEN=[preview_token_longo]
NEXT_PUBLIC_STRAPI_API_TOKEN=[preview_token_longo]

# Algolia Development
NEXT_PUBLIC_ALGOLIA_APP_ID=42TZWHW8UP
NEXT_PUBLIC_ALGOLIA_SEARCH_API_KEY=b32edbeb383fc3d1279658e7c3661843
NEXT_PUBLIC_ALGOLIA_INDEX_NAME=development_mcpx_content
ALGOLIA_ADMIN_API_KEY=d0cb55ec8f07832bc5f57da0bd25c535
ALGOLIA_WRITE_API_KEY=197d9ad99abb5bb69b4703dfb4820d2c

# Google API
GOOGLE_API_KEY=AIzaSyALJKZfAQLrHp-pRJmUZDJvESIWYQ8561U
```

### **`.env.production` (Produ√ß√£o)**
Todas as configura√ß√µes para o ambiente de produ√ß√£o:

```bash
# Telemetria e Analytics
NEXT_TELEMETRY_DISABLED=1
NEXT_PUBLIC_GA_MEASUREMENT_ID=G-SFGD9XKTLD

# Redis (para Docker)
REDIS_HOST=redis
REDIS_PORT=6379

# Strapi Production
NEXT_PUBLIC_STRAPI_URL=https://ale-blog.agentesintegrados.com
STRAPI_API_TOKEN=[production_token_longo]
NEXT_PUBLIC_STRAPI_API_TOKEN=[production_token_longo]

# Node Environment
NODE_ENV=production
PORT=3000

# Algolia Production
NEXT_PUBLIC_ALGOLIA_APP_ID=42TZWHW8UP
NEXT_PUBLIC_ALGOLIA_SEARCH_API_KEY=b32edbeb383fc3d1279658e7c3661843
NEXT_PUBLIC_ALGOLIA_INDEX_NAME=production_mcpx_content
ALGOLIA_ADMIN_API_KEY=d0cb55ec8f07832bc5f57da0bd25c535
ALGOLIA_WRITE_API_KEY=197d9ad99abb5bb69b4703dfb4820d2c

# Google API
GOOGLE_API_KEY=AIzaSyALJKZfAQLrHp-pRJmUZDJvESIWYQ8561U
```

---

## üîÄ **Mapeamento de Ambientes**

### **üü° PREVIEW/DESENVOLVIMENTO**
```
Frontend:
‚îú‚îÄ‚îÄ üìÅ Arquivo: .env.preview
‚îú‚îÄ‚îÄ üåê URL: N/A (desenvolvimento local)
‚îî‚îÄ‚îÄ üéØ Uso: Testes, desenvolvimento, valida√ß√£o

Backend Strapi:
‚îú‚îÄ‚îÄ üåê URL: https://ale-blog-preview.agentesintegrados.com/
‚îú‚îÄ‚îÄ üö™ Porta: 1340
‚îú‚îÄ‚îÄ üóÑÔ∏è PostgreSQL: postgres-strapi-dev (porta 5434)
‚îú‚îÄ‚îÄ üê≥ Container: strapi-v5-dev-preview
‚îî‚îÄ‚îÄ üéØ Uso: API de testes, posts de desenvolvimento

Database:
‚îú‚îÄ‚îÄ üóÑÔ∏è Nome: strapi_dev
‚îú‚îÄ‚îÄ üë§ Usu√°rio: strapi_dev
‚îî‚îÄ‚îÄ üîß Reset: ./scripts/reset-database-development.sh
```

### **üü¢ PRODU√á√ÉO**
```
Frontend:
‚îú‚îÄ‚îÄ üìÅ Arquivo: .env.production
‚îú‚îÄ‚îÄ üåê URL: https://thecryptofrontier.agentesintegrados.com/
‚îú‚îÄ‚îÄ üö™ Porta: 3300
‚îú‚îÄ‚îÄ üê≥ Container: thecryptofrontier-frontend
‚îî‚îÄ‚îÄ üéØ Uso: Site p√∫blico, usu√°rios finais

Backend Strapi:
‚îú‚îÄ‚îÄ üåê URL: https://ale-blog.agentesintegrados.com/
‚îú‚îÄ‚îÄ üö™ Porta: 1339
‚îú‚îÄ‚îÄ üóÑÔ∏è PostgreSQL: ale-blog-postgres
‚îú‚îÄ‚îÄ üê≥ Container: ale-blog-strapi-v5
‚îî‚îÄ‚îÄ üéØ Uso: API de produ√ß√£o, posts p√∫blicos

Database:
‚îú‚îÄ‚îÄ üóÑÔ∏è Nome: strapi
‚îú‚îÄ‚îÄ üë§ Usu√°rio: strapi
‚îî‚îÄ‚îÄ üîß Reset: ./scripts/reset-database-production.sh
```

---

## üöÄ **Deploy por Ambiente**

### **Desenvolvimento Local**
```bash
# 1. Configurar arquivo local (primeira vez)
cd frontend-nextjs
cp .env.preview .env.local  # Cria arquivo para desenvolvimento local

# 2. Rodar em desenvolvimento
npm run dev

# 3. Acessar
# http://localhost:3300 ‚Üí conecta com ale-blog-preview.agentesintegrados.com
```

### **Preview/Desenvolvimento**
```bash
# 1. Verificar configura√ß√µes
cat frontend-nextjs/.env.preview

# 2. Configurar Strapi preview
docker compose -f infrastructure-docker/docker-yml/docker-compose.dev.yml up -d

# 3. Testar localmente (se necess√°rio)
cd frontend-nextjs
cp .env.preview .env.local  # Para desenvolvimento local
npm run dev
```

### **Produ√ß√£o**
```bash
# 1. Verificar configura√ß√µes
cat frontend-nextjs/.env.production

# 2. Deploy do frontend
cd infrastructure-docker/docker-yml
docker compose -f docker-compose.frontend.yml down
docker compose -f docker-compose.frontend.yml build
docker compose -f docker-compose.frontend.yml up -d

# 3. Verificar Strapi de produ√ß√£o
docker compose -f docker-compose.yml ps
```

---

## üîÑ **Switching Entre Ambientes**

### **Para Desenvolvimento Local**
```bash
# Usar configura√ß√µes de preview para desenvolvimento local
cd frontend-nextjs
cp .env.preview .env.local  # Se usando desenvolvimento local
npm run dev  # Roda na porta 3000 local
```

### **Para Testes de Preview**
```bash
# Strapi preview j√° est√° rodando em ale-blog-preview.agentesintegrados.com
# Frontend pode ser testado localmente apontando para preview
```

### **Para Deploy em Produ√ß√£o**
```bash
# Frontend automaticamente usa .env.production no container Docker
# Strapi de produ√ß√£o roda em ale-blog.agentesintegrados.com
```

---

## üõ°Ô∏è **Seguran√ßa e Isolamento**

### **Tokens de API Diferentes**
- **Preview**: Token com permiss√µes de desenvolvimento
- **Produ√ß√£o**: Token com permiss√µes restritivas de produ√ß√£o

### **Bancos de Dados Isolados**
- **Preview**: `postgres-strapi-dev` (porta 5434)
- **Produ√ß√£o**: `ale-blog-postgres` (porta padr√£o)

### **√çndices Algolia Separados**
- **Preview**: `development_mcpx_content`
- **Produ√ß√£o**: `production_mcpx_content`

---

## üîß **Comandos √öteis**

### **Verificar Configura√ß√£o Atual**
```bash
# Ver vari√°veis carregadas
cd frontend-nextjs
cat .env.preview  # ou .env.production

# Testar conex√µes
curl https://ale-blog-preview.agentesintegrados.com/api/posts
curl https://ale-blog.agentesintegrados.com/api/posts
```

### **Alternar Configura√ß√µes**
```bash
# Para desenvolvimento local com preview
cp .env.preview .env.local

# Para desenvolvimento local com produ√ß√£o (CUIDADO!)
cp .env.production .env.local
```

### **Reset por Ambiente**
```bash
# Preview/desenvolvimento
./scripts/reset-database-development.sh

# Produ√ß√£o (CUIDADO!)
./scripts/reset-database-production.sh

# Ambos
./scripts/reset-database-complete.sh
```

---

## üìä **Monitoramento por Ambiente**

### **Health Checks**
```bash
# Preview
curl -s https://ale-blog-preview.agentesintegrados.com/api/posts > /dev/null && echo "‚úÖ Preview OK" || echo "‚ùå Preview ERRO"

# Produ√ß√£o  
curl -s https://ale-blog.agentesintegrados.com/api/posts > /dev/null && echo "‚úÖ Produ√ß√£o OK" || echo "‚ùå Produ√ß√£o ERRO"
curl -s https://thecryptofrontier.agentesintegrados.com/ > /dev/null && echo "‚úÖ Frontend OK" || echo "‚ùå Frontend ERRO"
```

### **Status dos Containers**
```bash
# Preview
docker ps | grep "strapi-v5-dev-preview\|postgres-strapi-dev"

# Produ√ß√£o
docker ps | grep "ale-blog-strapi-v5\|ale-blog-postgres\|thecryptofrontier-frontend"
```

---

## üêõ **Troubleshooting por Ambiente**

### **Preview n√£o Funciona**
```bash
# Verificar container
docker logs strapi-v5-dev-preview --tail=20

# Verificar banco
docker exec postgres-strapi-dev pg_isready -U strapi_dev

# Verificar vari√°veis
cat frontend-nextjs/.env.preview | grep STRAPI_URL
```

### **Produ√ß√£o n√£o Funciona**
```bash
# Verificar containers
docker logs ale-blog-strapi-v5 --tail=20
docker logs thecryptofrontier-frontend --tail=20

# Verificar banco
docker exec ale-blog-postgres pg_isready -U strapi

# Verificar vari√°veis
docker exec thecryptofrontier-frontend printenv | grep STRAPI
```

---

## üìÖ **Boas Pr√°ticas**

### **‚úÖ Recomendado**
- Sempre testar em **preview** antes de aplicar em **produ√ß√£o**
- Usar tokens diferentes para cada ambiente
- Manter bancos de dados isolados
- Fazer backup antes de mudan√ßas em produ√ß√£o

### **‚ùå Evitar**
- Usar token de produ√ß√£o em desenvolvimento
- Conectar desenvolvimento ao banco de produ√ß√£o
- Aplicar mudan√ßas direto em produ√ß√£o sem testes
- Compartilhar tokens entre ambientes

---

## üîó **URLs de Acesso**

| Ambiente | Tipo | URL | Porta |
|----------|------|-----|-------|
| Preview | Strapi Admin | https://ale-blog-preview.agentesintegrados.com/admin | 1340 |
| Preview | Strapi API | https://ale-blog-preview.agentesintegrados.com/api | 1340 |
| Produ√ß√£o | Strapi Admin | https://ale-blog.agentesintegrados.com/admin | 1339 |
| Produ√ß√£o | Strapi API | https://ale-blog.agentesintegrados.com/api | 1339 |
| Produ√ß√£o | Frontend | https://thecryptofrontier.agentesintegrados.com/ | 3300 |

---

**üìù Criado em: 06/07/2024**  
**üë§ Autor: Claude Agent**  
**üîÑ √öltima atualiza√ß√£o: 06/07/2024**  
**üéØ Estrutura: .env.preview + .env.production** 