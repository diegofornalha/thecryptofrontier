#!/usr/bin/env node

/**
 * Script para configurar o Strapi completamente via CLI
 * Cria token, configura permiss√µes e prepara o ambiente
 */

const axios = require('axios');
const fs = require('fs');
const path = require('path');
const chalk = require('chalk');
const inquirer = require('inquirer');
require('dotenv').config();

const log = {
  success: (msg) => console.log(chalk.green('‚úì'), msg),
  error: (msg) => console.log(chalk.red('‚úó'), msg),
  info: (msg) => console.log(chalk.blue('‚Ñπ'), msg),
  warn: (msg) => console.log(chalk.yellow('‚ö†'), msg),
};

class StrapiSetup {
  constructor() {
    this.baseUrl = process.env.NEXT_PUBLIC_STRAPI_URL || 'https://ale-blog.agentesintegrados.com';
    this.adminEmail = null;
    this.adminPassword = null;
    this.adminToken = null;
    this.apiToken = null;
  }

  async setup() {
    console.log(chalk.bold('\nüöÄ Configura√ß√£o do Strapi via CLI\n'));
    
    try {
      // 1. Obter credenciais do admin
      await this.getAdminCredentials();
      
      // 2. Fazer login como admin
      await this.adminLogin();
      
      // 3. Criar token de API
      await this.createApiToken();
      
      // 4. Configurar permiss√µes p√∫blicas
      await this.configurePublicPermissions();
      
      // 5. Salvar configura√ß√µes
      await this.saveConfiguration();
      
      // 6. Testar configura√ß√£o
      await this.testConfiguration();
      
      log.success('\n‚úÖ Configura√ß√£o conclu√≠da com sucesso!\n');
      
    } catch (error) {
      log.error(`\nErro durante a configura√ß√£o: ${error.message}\n`);
      process.exit(1);
    }
  }

  async getAdminCredentials() {
    log.info('Primeiro, precisamos das credenciais de administrador do Strapi.\n');
    
    const answers = await inquirer.prompt([
      {
        type: 'input',
        name: 'email',
        message: 'Email do administrador:',
        validate: (input) => input.includes('@') || 'Por favor, insira um email v√°lido'
      },
      {
        type: 'password',
        name: 'password',
        message: 'Senha do administrador:',
        mask: '*',
        validate: (input) => input.length > 0 || 'Senha √© obrigat√≥ria'
      }
    ]);
    
    this.adminEmail = answers.email;
    this.adminPassword = answers.password;
  }

  async adminLogin() {
    log.info('Fazendo login como administrador...');
    
    try {
      const response = await axios.post(`${this.baseUrl}/admin/login`, {
        email: this.adminEmail,
        password: this.adminPassword
      });
      
      this.adminToken = response.data.data.token;
      log.success('Login realizado com sucesso!');
      
    } catch (error) {
      throw new Error('Falha no login. Verifique as credenciais.');
    }
  }

  async createApiToken() {
    log.info('Criando token de API...');
    
    const tokenName = `Frontend Token - ${new Date().toLocaleDateString('pt-BR')}`;
    
    try {
      const response = await axios.post(
        `${this.baseUrl}/admin/api-tokens`,
        {
          name: tokenName,
          description: 'Token para o frontend Next.js',
          type: 'full-access', // ou 'read-only' / 'custom'
          lifespan: null // Token sem expira√ß√£o
        },
        {
          headers: {
            'Authorization': `Bearer ${this.adminToken}`
          }
        }
      );
      
      this.apiToken = response.data.data.accessKey;
      log.success(`Token de API criado: ${tokenName}`);
      
    } catch (error) {
      // Se falhar, tenta listar tokens existentes
      log.warn('N√£o foi poss√≠vel criar novo token. Listando tokens existentes...');
      await this.listExistingTokens();
    }
  }

  async listExistingTokens() {
    try {
      const response = await axios.get(`${this.baseUrl}/admin/api-tokens`, {
        headers: {
          'Authorization': `Bearer ${this.adminToken}`
        }
      });
      
      const tokens = response.data.data;
      
      if (tokens.length > 0) {
        log.info(`\nTokens existentes:`);
        tokens.forEach((token, index) => {
          console.log(`${index + 1}. ${token.name} (${token.type})`);
        });
        
        const answer = await inquirer.prompt([
          {
            type: 'list',
            name: 'useExisting',
            message: 'Deseja usar um token existente?',
            choices: [
              { name: 'Criar novo token', value: 'new' },
              ...tokens.map(t => ({ name: t.name, value: t.id }))
            ]
          }
        ]);
        
        if (answer.useExisting !== 'new') {
          log.warn('‚ö†Ô∏è  Tokens existentes n√£o mostram a chave. Voc√™ precisar√° gerar um novo ou usar um que j√° tenha salvo.');
        }
      }
    } catch (error) {
      log.error('Erro ao listar tokens');
    }
  }

  async configurePublicPermissions() {
    log.info('Configurando permiss√µes p√∫blicas...');
    
    try {
      // Buscar role p√∫blico
      const rolesResponse = await axios.get(`${this.baseUrl}/admin/roles`, {
        headers: {
          'Authorization': `Bearer ${this.adminToken}`
        }
      });
      
      const publicRole = rolesResponse.data.data.find(role => role.type === 'public');
      
      if (publicRole) {
        // Configurar permiss√µes para Posts
        const permissions = {
          'api::post.post': {
            controllers: {
              post: {
                find: { enabled: true },
                findOne: { enabled: true }
              }
            }
          },
          'api::author.author': {
            controllers: {
              author: {
                find: { enabled: true },
                findOne: { enabled: true }
              }
            }
          },
          'api::category.category': {
            controllers: {
              category: {
                find: { enabled: true },
                findOne: { enabled: true }
              }
            }
          }
        };
        
        await axios.put(
          `${this.baseUrl}/admin/roles/${publicRole.id}`,
          {
            permissions
          },
          {
            headers: {
              'Authorization': `Bearer ${this.adminToken}`
            }
          }
        );
        
        log.success('Permiss√µes p√∫blicas configuradas!');
      }
    } catch (error) {
      log.warn('N√£o foi poss√≠vel configurar permiss√µes automaticamente. Configure manualmente no painel admin.');
    }
  }

  async saveConfiguration() {
    log.info('Salvando configura√ß√µes...');
    
    const envPath = path.resolve('.env.local');
    const envContent = `
# Configura√ß√£o do Strapi - Gerado automaticamente
NEXT_PUBLIC_STRAPI_URL=${this.baseUrl}
STRAPI_API_TOKEN=${this.apiToken || 'CONFIGURE_MANUALMENTE'}
`;
    
    // Adiciona ao .env.local
    if (fs.existsSync(envPath)) {
      const currentContent = fs.readFileSync(envPath, 'utf-8');
      if (!currentContent.includes('STRAPI_API_TOKEN')) {
        fs.appendFileSync(envPath, envContent);
      } else {
        log.warn('.env.local j√° cont√©m configura√ß√µes do Strapi. Atualize manualmente se necess√°rio.');
      }
    } else {
      fs.writeFileSync(envPath, envContent);
    }
    
    log.success('Configura√ß√µes salvas em .env.local');
  }

  async testConfiguration() {
    log.info('\nTestando a configura√ß√£o...\n');
    
    if (!this.apiToken) {
      log.warn('Token de API n√£o foi criado automaticamente. Configure manualmente.');
      return;
    }
    
    try {
      // Testa buscar posts
      const response = await axios.get(`${this.baseUrl}/api/posts`, {
        headers: {
          'Authorization': `Bearer ${this.apiToken}`
        }
      });
      
      log.success(`‚úÖ API funcionando! ${response.data.data.length} posts encontrados.`);
      
      // Oferece criar post de teste
      const answer = await inquirer.prompt([
        {
          type: 'confirm',
          name: 'createTest',
          message: 'Deseja criar um post de teste?',
          default: true
        }
      ]);
      
      if (answer.createTest) {
        await this.createTestPost();
      }
      
    } catch (error) {
      log.error('Erro ao testar API. Verifique as configura√ß√µes.');
    }
  }

  async createTestPost() {
    try {
      const postData = {
        data: {
          title: "Post de Teste - Configura√ß√£o CLI",
          slug: "teste-cli-" + Date.now(),
          content: "Este post foi criado automaticamente durante a configura√ß√£o via CLI. üéâ",
          excerpt: "Post de teste",
          publishedAt: new Date().toISOString()
        }
      };
      
      const response = await axios.post(
        `${this.baseUrl}/api/posts`,
        postData,
        {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiToken}`
          }
        }
      );
      
      log.success('Post de teste criado com sucesso!');
      log.info(`Veja em: https://thecryptofrontier.agentesintegrados.com/blog/${postData.data.slug}`);
      
    } catch (error) {
      log.error('Erro ao criar post de teste');
    }
  }
}

// Script para configura√ß√£o simplificada (sem login admin)
async function quickSetup() {
  console.log(chalk.bold('\nüöÄ Configura√ß√£o R√°pida do Strapi\n'));
  
  const answers = await inquirer.prompt([
    {
      type: 'input',
      name: 'url',
      message: 'URL do Strapi:',
      default: process.env.NEXT_PUBLIC_STRAPI_URL || 'https://ale-blog.agentesintegrados.com'
    },
    {
      type: 'password',
      name: 'token',
      message: 'Token da API (deixe em branco se n√£o tiver):',
      mask: '*'
    }
  ]);
  
  // Salva configura√ß√µes
  const envPath = path.resolve('.env.local');
  const envContent = `
# Configura√ß√£o do Strapi
NEXT_PUBLIC_STRAPI_URL=${answers.url}
STRAPI_API_TOKEN=${answers.token}
`;
  
  if (fs.existsSync(envPath)) {
    // L√™ o arquivo existente
    let currentContent = fs.readFileSync(envPath, 'utf-8');
    
    // Atualiza ou adiciona as vari√°veis
    if (currentContent.includes('NEXT_PUBLIC_STRAPI_URL')) {
      currentContent = currentContent.replace(
        /NEXT_PUBLIC_STRAPI_URL=.*/g,
        `NEXT_PUBLIC_STRAPI_URL=${answers.url}`
      );
    } else {
      currentContent += `\nNEXT_PUBLIC_STRAPI_URL=${answers.url}`;
    }
    
    if (currentContent.includes('STRAPI_API_TOKEN')) {
      currentContent = currentContent.replace(
        /STRAPI_API_TOKEN=.*/g,
        `STRAPI_API_TOKEN=${answers.token}`
      );
    } else {
      currentContent += `\nSTRAPI_API_TOKEN=${answers.token}`;
    }
    
    fs.writeFileSync(envPath, currentContent);
  } else {
    fs.writeFileSync(envPath, envContent);
  }
  
  log.success('\n‚úÖ Configura√ß√£o salva em .env.local\n');
  
  if (!answers.token) {
    log.info('üìù Pr√≥ximos passos:');
    log.info('1. Acesse o painel admin do Strapi');
    log.info('2. V√° para Settings > API Tokens');
    log.info('3. Crie um novo token com permiss√µes de leitura/escrita');
    log.info('4. Adicione o token ao arquivo .env.local');
  }
}

// Menu principal
async function main() {
  const answer = await inquirer.prompt([
    {
      type: 'list',
      name: 'mode',
      message: 'Escolha o modo de configura√ß√£o:',
      choices: [
        { name: 'Configura√ß√£o R√°pida (recomendado)', value: 'quick' },
        { name: 'Configura√ß√£o Completa (requer credenciais admin)', value: 'full' },
        { name: 'Testar configura√ß√£o existente', value: 'test' }
      ]
    }
  ]);
  
  switch (answer.mode) {
    case 'quick':
      await quickSetup();
      break;
    case 'full':
      const setup = new StrapiSetup();
      await setup.setup();
      break;
    case 'test':
      const testSetup = new StrapiSetup();
      await testSetup.testConfiguration();
      break;
  }
}

// Executa
if (require.main === module) {
  main().catch(error => {
    log.error(`Erro: ${error.message}`);
    process.exit(1);
  });
}

module.exports = { StrapiSetup, quickSetup };