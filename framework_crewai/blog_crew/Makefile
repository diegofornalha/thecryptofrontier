# Makefile para CrewAI Blog Pipeline Docker

.PHONY: help build up down logs status shell pipeline clean

# Cores para output
GREEN  := \033[0;32m
YELLOW := \033[0;33m
RED    := \033[0;31m
NC     := \033[0m

help: ## Mostra esta ajuda
	@echo "$(GREEN)CrewAI Blog Pipeline - Comandos Docker$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-15s$(NC) %s\n", $$1, $$2}'

build: ## ConstrÃ³i a imagem Docker
	@echo "$(GREEN)ğŸ”¨ Construindo imagem Docker...$(NC)"
	docker compose build

up: ## Inicia os containers em modo daemon
	@echo "$(GREEN)ğŸš€ Iniciando containers...$(NC)"
	docker compose up -d

down: ## Para e remove os containers
	@echo "$(RED)ğŸ›‘ Parando containers...$(NC)"
	docker compose down

logs: ## Mostra os logs do container principal
	@echo "$(GREEN)ğŸ“‹ Logs do container principal:$(NC)"
	docker compose logs -f blog-crew

logs-monitor: ## Mostra os logs do monitor
	@echo "$(GREEN)ğŸ“Š Logs do monitor:$(NC)"
	docker compose logs -f blog-crew-monitor

status: ## Mostra o status dos containers
	@echo "$(GREEN)ğŸ“Š Status dos containers:$(NC)"
	docker compose ps

shell: ## Acessa o shell do container principal
	@echo "$(GREEN)ğŸš Acessando shell do container...$(NC)"
	docker compose run --rm blog-crew shell

pipeline: ## Executa o pipeline para 10 artigos (padrÃ£o)
	@echo "$(GREEN)ğŸ”„ Executando pipeline para 10 artigos...$(NC)"
	docker compose run --rm blog-crew once

pipeline-1: ## Executa o pipeline para 1 artigo
	@echo "$(GREEN)ğŸ”„ Processando 1 artigo...$(NC)"
	docker compose run --rm -e ARTICLE_LIMIT=1 blog-crew once

pipeline-5: ## Executa o pipeline para 5 artigos
	@echo "$(GREEN)ğŸ”„ Processando 5 artigos...$(NC)"
	docker compose run --rm -e ARTICLE_LIMIT=5 blog-crew once

pipeline-images: ## Executa o pipeline com geraÃ§Ã£o de imagens
	@echo "$(GREEN)ğŸ–¼ï¸  Executando pipeline com imagens...$(NC)"
	docker compose run --rm -e GENERATE_IMAGES=true blog-crew once

clean: ## Remove volumes e limpa dados
	@echo "$(RED)ğŸ—‘ï¸  Limpando volumes e dados...$(NC)"
	docker compose down -v
	rm -f processed_articles.json strapi_assets.json
	rm -rf src/pipelines/simple/posts_processados/*
	rm -rf src/pipelines/simple/posts_imagens/*

restart: down up ## Reinicia os containers

rebuild: down build up ## ReconstrÃ³i e reinicia tudo

monitor: ## Abre o monitor no navegador
	@echo "$(GREEN)ğŸŒ Abrindo monitor em http://localhost:8080$(NC)"
	@open http://localhost:8080 || xdg-open http://localhost:8080 || echo "Acesse: http://localhost:8080"

test: ## Testa a configuraÃ§Ã£o
	@echo "$(GREEN)ğŸ§ª Testando configuraÃ§Ã£o...$(NC)"
	@docker compose run --rm blog-crew python -c "import os; print('âœ… strapi_PROJECT_ID:', 'OK' if os.getenv('strapi_PROJECT_ID') else 'âŒ MISSING')"
	@docker compose run --rm blog-crew python -c "import os; print('âœ… OPENAI_API_KEY:', 'OK' if os.getenv('OPENAI_API_KEY') else 'âŒ MISSING')"
	@docker compose run --rm blog-crew python -c "import os; print('âœ… GEMINI_API_KEY:', 'OK' if os.getenv('GEMINI_API_KEY') else 'âŒ MISSING')"