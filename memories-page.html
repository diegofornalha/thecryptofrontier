<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Memórias - Claude Flow Diego</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .memory-card {
            transition: all 0.3s ease;
        }
        .memory-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }
        @keyframes skeleton-loading {
            0% { background-color: #f3f4f6; }
            100% { background-color: #e5e7eb; }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-brain text-purple-600 mr-2"></i>
                        Gestão de Memórias
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshMemories()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                        <i class="fas fa-sync-alt mr-2"></i>Atualizar
                    </button>
                    <button onclick="showAddMemoryModal()" class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded-lg transition">
                        <i class="fas fa-plus mr-2"></i>Nova Memória
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total de Memórias</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-memories">-</p>
                    </div>
                    <i class="fas fa-database text-purple-600 text-3xl"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Usuários</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-users">-</p>
                    </div>
                    <i class="fas fa-users text-blue-600 text-3xl"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Categorias</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-categories">-</p>
                    </div>
                    <i class="fas fa-tags text-green-600 text-3xl"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Última Atualização</p>
                        <p class="text-sm font-medium text-gray-900" id="last-update">-</p>
                    </div>
                    <i class="fas fa-clock text-orange-600 text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
                    <input type="text" id="search-input" placeholder="Buscar memórias..." 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           onkeyup="handleSearch(event)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                    <select id="user-filter" onchange="filterMemories()" 
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Todos os usuários</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                    <select id="category-filter" onchange="filterMemories()" 
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Todas as categorias</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ordenar por</label>
                    <select id="sort-filter" onchange="filterMemories()" 
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="created_desc">Mais recentes</option>
                        <option value="created_asc">Mais antigas</option>
                        <option value="user">Por usuário</option>
                        <option value="category">Por categoria</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Memories Grid -->
        <div id="memories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Loading skeleton -->
            <div class="skeleton bg-white rounded-lg shadow p-6 h-48"></div>
            <div class="skeleton bg-white rounded-lg shadow p-6 h-48"></div>
            <div class="skeleton bg-white rounded-lg shadow p-6 h-48"></div>
        </div>

        <!-- No memories message -->
        <div id="no-memories" class="hidden text-center py-12">
            <i class="fas fa-brain text-gray-300 text-6xl mb-4"></i>
            <p class="text-gray-500 text-lg">Nenhuma memória encontrada</p>
        </div>
    </div>

    <!-- Add Memory Modal -->
    <div id="add-memory-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-plus-circle text-purple-600 mr-2"></i>
                        Nova Memória
                    </h3>
                    <button onclick="closeAddMemoryModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="add-memory-form" onsubmit="submitMemory(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                        <input type="text" id="new-user-id" required 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="Ex: agent-name, user-123">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Conteúdo da Memória</label>
                        <textarea id="new-memory-content" required rows="4"
                                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Digite o conteúdo da memória..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoria (opcional)</label>
                        <input type="text" id="new-category" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="Ex: configuração, aprendizado, contexto">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tags (opcional)</label>
                        <input type="text" id="new-tags" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="Separe por vírgulas: docker, portainer, config">
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeAddMemoryModal()" 
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
                            Cancelar
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded-lg transition">
                            <i class="fas fa-save mr-2"></i>Salvar Memória
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Memory Modal -->
    <div id="view-memory-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-eye text-blue-600 mr-2"></i>
                        Detalhes da Memória
                    </h3>
                    <button onclick="closeViewMemoryModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6" id="memory-details">
                <!-- Memory details will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allMemories = [];
        let currentFilters = {
            search: '',
            user: '',
            category: '',
            sort: 'created_desc'
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMemories();
            setInterval(updateStats, 30000); // Update stats every 30 seconds
        });

        // Load memories from API
        async function loadMemories() {
            try {
                const response = await fetch('/api/memories');
                const data = await response.json();
                
                if (data.success) {
                    allMemories = data.memories || [];
                    updateStats();
                    populateFilters();
                    renderMemories();
                } else {
                    showError('Erro ao carregar memórias');
                }
            } catch (error) {
                console.error('Error loading memories:', error);
                showError('Erro ao conectar com o servidor');
            }
        }

        // Update statistics
        async function updateStats() {
            try {
                const response = await fetch('http://localhost:3002/health');
                const data = await response.json();
                
                document.getElementById('total-memories').textContent = data.memory_count || '0';
                document.getElementById('total-users').textContent = data.users_count || '0';
                document.getElementById('last-update').textContent = formatDate(data.timestamp);
                
                // Update categories count
                const categories = new Set(allMemories.map(m => m.category).filter(Boolean));
                document.getElementById('total-categories').textContent = categories.size;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Users
            const users = [...new Set(allMemories.map(m => m.user_id))];
            const userSelect = document.getElementById('user-filter');
            userSelect.innerHTML = '<option value="">Todos os usuários</option>';
            users.forEach(user => {
                userSelect.innerHTML += `<option value="${user}">${user}</option>`;
            });

            // Categories
            const categories = [...new Set(allMemories.map(m => m.category).filter(Boolean))];
            const categorySelect = document.getElementById('category-filter');
            categorySelect.innerHTML = '<option value="">Todas as categorias</option>';
            categories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
            });
        }

        // Render memories grid
        function renderMemories() {
            const container = document.getElementById('memories-container');
            const filteredMemories = filterAndSortMemories();
            
            if (filteredMemories.length === 0) {
                container.innerHTML = '';
                document.getElementById('no-memories').classList.remove('hidden');
                return;
            }
            
            document.getElementById('no-memories').classList.add('hidden');
            container.innerHTML = filteredMemories.map(memory => createMemoryCard(memory)).join('');
        }

        // Create memory card HTML
        function createMemoryCard(memory) {
            const truncatedContent = memory.content.length > 150 
                ? memory.content.substring(0, 150) + '...' 
                : memory.content;
            
            const tags = memory.tags ? memory.tags.map(tag => 
                `<span class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">${tag}</span>`
            ).join(' ') : '';
            
            return `
                <div class="memory-card bg-white rounded-lg shadow p-6 cursor-pointer" onclick="viewMemory('${memory.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-gray-400 text-2xl mr-2"></i>
                            <div>
                                <p class="font-semibold text-gray-900">${memory.user_id}</p>
                                ${memory.category ? `<p class="text-xs text-gray-500">${memory.category}</p>` : ''}
                            </div>
                        </div>
                        <button onclick="deleteMemory(event, '${memory.id}')" 
                                class="text-red-500 hover:text-red-700 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <p class="text-gray-700 mb-3">${escapeHtml(truncatedContent)}</p>
                    ${tags ? `<div class="mb-3">${tags}</div>` : ''}
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        ${formatDate(memory.created_at)}
                    </p>
                </div>
            `;
        }

        // Filter and sort memories
        function filterAndSortMemories() {
            let filtered = [...allMemories];
            
            // Apply search filter
            if (currentFilters.search) {
                const searchLower = currentFilters.search.toLowerCase();
                filtered = filtered.filter(m => 
                    m.content.toLowerCase().includes(searchLower) ||
                    m.user_id.toLowerCase().includes(searchLower) ||
                    (m.category && m.category.toLowerCase().includes(searchLower)) ||
                    (m.tags && m.tags.some(tag => tag.toLowerCase().includes(searchLower)))
                );
            }
            
            // Apply user filter
            if (currentFilters.user) {
                filtered = filtered.filter(m => m.user_id === currentFilters.user);
            }
            
            // Apply category filter
            if (currentFilters.category) {
                filtered = filtered.filter(m => m.category === currentFilters.category);
            }
            
            // Apply sorting
            switch (currentFilters.sort) {
                case 'created_asc':
                    filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'created_desc':
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'user':
                    filtered.sort((a, b) => a.user_id.localeCompare(b.user_id));
                    break;
                case 'category':
                    filtered.sort((a, b) => (a.category || '').localeCompare(b.category || ''));
                    break;
            }
            
            return filtered;
        }

        // Handle search
        function handleSearch(event) {
            currentFilters.search = event.target.value;
            renderMemories();
        }

        // Filter memories
        function filterMemories() {
            currentFilters.user = document.getElementById('user-filter').value;
            currentFilters.category = document.getElementById('category-filter').value;
            currentFilters.sort = document.getElementById('sort-filter').value;
            renderMemories();
        }

        // View memory details
        async function viewMemory(memoryId) {
            const memory = allMemories.find(m => m.id === memoryId);
            if (!memory) return;
            
            const detailsHtml = `
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-gray-500">ID da Memória</label>
                        <p class="text-gray-900">${memory.id}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-500">Usuário</label>
                        <p class="text-gray-900">${memory.user_id}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-500">Conteúdo</label>
                        <p class="text-gray-900 whitespace-pre-wrap">${escapeHtml(memory.content)}</p>
                    </div>
                    ${memory.category ? `
                    <div>
                        <label class="text-sm font-medium text-gray-500">Categoria</label>
                        <p class="text-gray-900">${memory.category}</p>
                    </div>
                    ` : ''}
                    ${memory.tags && memory.tags.length > 0 ? `
                    <div>
                        <label class="text-sm font-medium text-gray-500">Tags</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${memory.tags.map(tag => 
                                `<span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full">${tag}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                    <div>
                        <label class="text-sm font-medium text-gray-500">Criado em</label>
                        <p class="text-gray-900">${formatDate(memory.created_at, true)}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('memory-details').innerHTML = detailsHtml;
            document.getElementById('view-memory-modal').classList.add('show');
        }

        // Delete memory
        async function deleteMemory(event, memoryId) {
            event.stopPropagation();
            
            if (!confirm('Tem certeza que deseja excluir esta memória?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/memories/${memoryId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showSuccess('Memória excluída com sucesso');
                    loadMemories();
                } else {
                    showError('Erro ao excluir memória');
                }
            } catch (error) {
                console.error('Error deleting memory:', error);
                showError('Erro ao conectar com o servidor');
            }
        }

        // Show add memory modal
        function showAddMemoryModal() {
            document.getElementById('add-memory-form').reset();
            document.getElementById('add-memory-modal').classList.add('show');
        }

        // Close add memory modal
        function closeAddMemoryModal() {
            document.getElementById('add-memory-modal').classList.remove('show');
        }

        // Close view memory modal
        function closeViewMemoryModal() {
            document.getElementById('view-memory-modal').classList.remove('show');
        }

        // Submit new memory
        async function submitMemory(event) {
            event.preventDefault();
            
            const formData = {
                user_id: document.getElementById('new-user-id').value,
                memory: document.getElementById('new-memory-content').value,
                category: document.getElementById('new-category').value || undefined,
                tags: document.getElementById('new-tags').value 
                    ? document.getElementById('new-tags').value.split(',').map(t => t.trim()).filter(Boolean)
                    : undefined
            };
            
            try {
                const response = await fetch('/api/memories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('Memória adicionada com sucesso');
                    closeAddMemoryModal();
                    loadMemories();
                } else {
                    showError('Erro ao adicionar memória');
                }
            } catch (error) {
                console.error('Error adding memory:', error);
                showError('Erro ao conectar com o servidor');
            }
        }

        // Refresh memories
        function refreshMemories() {
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            icon.classList.add('fa-spin');
            
            loadMemories().then(() => {
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                }, 500);
            });
        }

        // Utility functions
        function formatDate(dateString, full = false) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            
            if (full) {
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Agora mesmo';
            if (minutes < 60) return `${minutes} min atrás`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h atrás`;
            
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d atrás`;
            
            return date.toLocaleDateString('pt-BR');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function showSuccess(message) {
            // Simple alert for now, can be replaced with toast notification
            alert('✅ ' + message);
        }

        function showError(message) {
            // Simple alert for now, can be replaced with toast notification
            alert('❌ ' + message);
        }
    </script>
</body>
</html>